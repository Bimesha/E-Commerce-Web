<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Buda&display=swap"
      rel="stylesheet"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/png"
      href="./assets/images/nav-img/fav-logo.png"
    />

    <link rel="stylesheet" href="./assets/css/nav.css" />
    <link rel="stylesheet" href="./assets/css/review.css" />
    <link rel="stylesheet" href="./assets/css/navbar-forms.css" />
    <link rel="stylesheet" href="./assets/css/footer.css" />
    <link rel="stylesheet" href="./assets/css/contact.css" />

    <title>Oakly | Furniture</title>
  </head>
  <body>
    <!-- Special Header Component -->
    <special-header></special-header>
    <script src="./assets/widgets/header.js"></script>

    <section class="review-page-section">
      <div class="container">
        <div class="row title">
          <div class="col-lg-12 col-md-12">
            <h1 class="mt-5 mb-3">Reviews</h1>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-12 col-md-12 col-sm-12 mb-5">
            <div class="card">
              <div class="card-body">
                <div class="card-header">
                  <div class="card-avatar">
                    <img
                      src="./assets/images/home-img/man-1.jpg"
                      alt="avatar"
                    />
                  </div>
                  <div class="card-name">
                    <h5 class="card-title">John Doe</h5>
                  </div>
                </div>

                <div class="card-content">
                  <p class="card-text">
                    " Exceptional service and stunning furniture! Our new dining
                    set arrived right on schedule, and the quality is truly
                    impressive. It has quickly become the centerpiece of our
                    dining room. We couldn’t be happier with our purchase and
                    the level of customer care we received. Every detail
                    reflects top-notch design. We look forward to purchasing
                    more pieces in the future! "
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="line"><hr /></div>

        <div class="row">
          <div class="col-lg-12 col-md-12 col-sm-12 mb-5">
            <div class="card">
              <div class="card-body">
                <div class="card-header">
                  <div class="card-avatar">
                    <img
                      src="./assets/images/home-img/man-2.jpg"
                      alt="avatar"
                    />
                  </div>
                  <div class="card-name">
                    <h5 class="card-title">Rav Denn</h5>
                  </div>
                </div>

                <div class="card-content">
                  <p class="card-text">
                    " Oakly has truly impressed us with their exceptional
                    service and product quality. The delivery was right on time,
                    and the furniture we received looks stunning. The
                    craftsmanship is impeccable, and the attention to detail is
                    evident in every piece. Thank you for making our home even
                    more beautiful—we'll definitely be recommending Oakly to our
                    friends and family! "
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="line"><hr /></div>

        <div class="row">
          <div class="col-lg-12 col-md-12 col-sm-12 mb-5">
            <div class="card">
              <div class="card-body">
                <div class="card-header">
                  <div class="card-avatar">
                    <img
                      src="./assets/images/home-img/man-3.jpg"
                      alt="avatar"
                    />
                  </div>
                  <div class="card-name">
                    <h5 class="card-title">Heri Mean</h5>
                  </div>
                </div>

                <div class="card-content">
                  <p class="card-text">
                    " Our experience with Oakly was outstanding from start to
                    finish. The delivery was prompt, and the furniture looks
                    even better in person than it did online. The quality is
                    top-notch, and the attention to detail in the craftsmanship
                    is remarkable. We couldn’t be happier with how these pieces
                    have transformed our space. Thank you for such a wonderful
                    experience! "
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      // Helper function to get a cookie by name
      function getCookie(name) {
        return document.cookie
          .split("; ")
          .find((row) => row.startsWith(name + "="))
          ?.split("=")[1];
      }

      // Function to parse JWT token
      function parseJwt(token) {
        const base64Url = token.split(".")[1];
        const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        const jsonPayload = decodeURIComponent(
          atob(base64)
            .split("")
            .map(function (c) {
              return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
            })
            .join("")
        );
        return JSON.parse(jsonPayload);
      }

      // Global variable to store the current user's ID
      let currentUserID = null;

      // Check for authentication token
      const token = getCookie("token");
      if (token) {
        const decodedToken = parseJwt(token);
        currentUserID = decodedToken.userId; 
      }

      // Function to delete a review
      function deleteReview(reviewId) {
        if (!token) {
          alert("You need to log in to delete your review.");
          return; // Prevent deletion if not logged in
        }

        if (confirm("Are you sure you want to delete this review?")) {
          fetch(`http://localhost:5500/api/reviews/user/${reviewId}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.message) {
                alert(data.message);
                location.reload(); // Reload to reflect changes
              } else {
                alert(data.error);
              }
            })
            .catch((error) => {
              console.error("Error deleting review:", error);
            });
        }
      }

      // Function to fetch and display reviews
      function fetchReviews() {
        fetch("http://localhost:5500/api/reviews/get-reviews", {
          method: "GET",
        })
          .then((response) => response.json())
          .then((data) => {
            const reviewsContainer = document.querySelector(
              ".review-page-section .row"
            );
            reviewsContainer.innerHTML = "";

            data.forEach((review) => {
              // Show delete button only if the review's UserID matches currentUserID
              const deleteButtonHTML =
                review.UserID === currentUserID
                  ? `<button class="btn btn-primary" onclick="deleteReview(${review.ReviewID})"><i class="fa-regular fa-trash-can"></i></button>`
                  : ""; // Empty string for other reviews

              const reviewHTML = `
                  <div class="container">
                    <div class="col-lg-12 col-md-12 col-sm-12" style="border-bottom: 1px solid #C0C0C0; padding-bottom: 10px;">
                      <div class="card">
                        <div class="card-body">
                          <div class="card-header">
                            <div class="card-avatar">
                              <img src="./assets/images/home-img/man-1.jpg" alt="avatar" />
                            </div>
                            <div class="card-name">
                              <h5 class="card-title">${review.FirstName} ${review.LastName}</h5>
                            </div>
                          </div>
                          <div class="card-content">
                            <p class="card-text">"${review.Comment}"</p>
                          </div>
                          <div class="review-footer">
                            <div class="delete-review">
                              ${deleteButtonHTML} <!-- Only the owner's delete button will be shown -->
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              reviewsContainer.innerHTML += reviewHTML;
            });
          })
          .catch((error) => {
            console.error("Error fetching reviews:", error);
          });
      }

      // Call the function to fetch reviews when the page loads
      window.onload = fetchReviews;
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/js/all.min.js"></script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script src="./assets/js/nav.js"></script>
    <script src="./assets/widgets/registration.js"></script>
    <script src="./assets/widgets/login.js"></script>
    <script src="./assets/js/form-validation.js"></script>

    <!-- Footer Component -->
    <script src="./assets/widgets/footer.js"></script>
  </body>
</html>
